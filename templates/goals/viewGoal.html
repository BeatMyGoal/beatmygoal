{% extends "base.html" %}
{% load staticfiles %}
{% block title %}{{ goal.title }}{% endblock %}
{% block content %}

<script src="{% static 'js/Chart.min.js' %}"></script>
<link rel="stylesheet" href="{% static 'css/goals/viewGoal.css' %}" />

<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=630259823729024";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<script src="{% static 'js/goals/viewGoal.js' %}"></script>
<script type="text/javascript" src="https://www.google.com/jsapi"></script>


<div class="row collapse card">
    <div class="row">
        <div class="small-12 columns no-padding">
            <img src="http://placehold.it/1080x300&text=goalPhoto" />
            <ul class="button-group right goal-buttons">
            {% if isParticipant or isCreator %}
                <!-- <li><a id = "favorite_button" type="submit" class="round button tiny pull-5">Favorite</a></li> -->
            {% endif %}
            {% if isParticipant and not isCreator %}
                <li><a id = "leave_goal_button" type="submit" class="button tiny pull-3">Leave Goal</a></li>
            {% endif %}
            {% if isParticipant %}
                <li><a id = "log_button" data-reveal-id="myModal" data-reveal class="button tiny pull-3">Log Progress</a></li>
                
            {% elif not isCreator and user.is_authenticated %}
                <li><a id = "join_goal_button" type="submit" class="button tiny pull-3">Join Goal</a></li>
            {% endif %}

            {% if user.username == goal.creator.username %}

            <li><a href="#" data-reveal-id="reveal_edit" class="button tiny pull-3 alert">Edit Goal</a> </li>
            {% endif %}


            {% if isFavorite and isParticipant %}
                <li><a id = "remove_favorite_button" type="button" class="button tiny alert">Remove Favorite</a></li>
            {% elif not isFavorite and isParticipant  %}

                <li><a id = "add_favorite_button" type="button" class="button tiny">Add to Favorites</a></li>
            {% endif %}
            </ul>
        </div>
    </div>
    
    <div class="row">
        <div class="medium-8 columns">
            <h2>{{ goal.title }}</h2>
        </div>
        <div class="medium-4 columns">
              <div class="row">
                  <div class="medium-12 columns">
                      <h3>Prize: {{ goal.prize }}</h3>
                  </div>
              </div>
              <div class="row">
                  <div class="medium-6 columns">
                      <h7>Goal: {{ goal.ending_value }} {{ goal.unit }}</h7>
                  </div>
                  <div class="medium-6 columns">
                      <h7>By {{ goal.ending_date.date|default:"No Deadline" }}</h7>
                  </div>
              </div>
        </div>
    </div>
</div>

<div class="row card">
    <div class="medium-9 small-12 columns">
        <div id='progressChart' style="width:100%; height:500px"></div>
    </div>
    <div class="medium-3 small-12 columns">
        {% if isParticipant %}
        <a href="#" data-dropdown="drop1" class="button dropdown tiny">Invite Friends</a>
        <ul id="drop1" data-dropdown-content class="f-dropdown">
            <li><a href="#" data-reveal-id="reveal_email" c>With Email</a></li>
            <div id="fb-root"></div>
            <li><div id="fb-send" class="fb-send" data-href="http://beatmygoal.com" data-colorscheme="light"></div><li>
        </ul>
        {% endif %}
        <ul class='no-list-style'>
        {% for participant in goal.beatmygoaluser_set.all %} 
            <li ><a href="/users/{{ participant.id }}" id="usr-{{ participant.username }}">{{ participant.username }} {% if participant.username == goal.creator.username %} (Creator) {% endif %}</a></li>
        {% endfor %}
        </ul>
    </div>
</div>

<div class="row card">
    <div class="medium-12 columns">
        <h3>Goal Feed</h3>
    </div>
    <div class="medium-12 columns">
         <ul class="log_entry_list no-list-style">
            {% for entry in goal.log.logentry_set.all %}
            <li>
            <div class="row">
                <div class="medium-1 hide-for-small columns">
                    {% if entry.participant.image %}
                    <img src="{{entry.participant.image.url}}" style="width:65px; height:65px" />
                    {% else %}
                    <img src="http://placehold.it/65x65&text=photo" />
                    {% endif %}
                </div>
                <div class="medium-11 columns">
                    <div class="row">
                        <a href="/users/{{ entry.participant.id }}"><strong>{{ entry.participant }}</strong></a> <small> logged {{ entry.entry_amount }} {{ goal.unit }} </small>
                    </div>
                    <div class="row">
                        {{ entry.comment }}
                    </div>
                </div>
            </div>
            </li>

            {% endfor %}
        </ul>
    </div>
</div>

<script type="text/javascript">

    // Load the Visualization API and the piechart package.
    google.load('visualization', '1.0', {'packages':['corechart']});
    var colors = COLORS.list();
    var chartColors = [];

    {% for user,amounts in progress.users %}
    chartColors.push(colors[{{ forloop.counter0 }}]);
    {% endfor %}

    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(drawChart);

    // Callback that creates and populates a data table, 
    // instantiates the pie chart, passes in the data and
    // draws it.
    function drawChart() {

        // Create the data table.
        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Day');
        {% for user,amounts in progress.users %}
            data.addColumn('number', "{{ user.username }}");
        {% endfor %}
        {% for day in progress.days %}
        data.addRow(['Day {{ day }}',{% for user,amounts in progress.users %}{% for amount in amounts %}{% if forloop.counter == forloop.parentloop.parentloop.counter %}{{ amount }},{% endif %}{% endfor %}{% endfor %}]);{% endfor %}

        // Set chart options
        var options = {
            focusTarget:"category",
            curveType : "none",
            colors : chartColors,
        };

        // Instantiate and draw our chart, passing in some options.
        chart = new google.visualization.LineChart(document.getElementById('progressChart'));
        chart.draw(data, options);

        var columns = [];
        var series = {};
        for (var i = 0; i < data.getNumberOfColumns(); i++) {
            columns.push(i);
            if (i > 0) {
                series[i - 1] = {};
            }
        }
        
        google.visualization.events.addListener(chart, 'select', function () {
            console.log("test");
            var sel = chart.getSelection();
            // if selection length is 0, we deselected an element
            if (sel.length > 0) {
                // if row is undefined, we clicked on the legend
                //if (typeof sel[0].row === 'undefined') {
                if (sel[0].row === null) {
                    var col = sel[0].column;
                    if (columns[col] == col) {
                        // hide the data series
                        columns[col] = {
                            label: data.getColumnLabel(col),
                            type: data.getColumnType(col),
                            calc: function () {
                                return null;
                            }
                        };
                        
                        // grey out the legend entry
                        series[col - 1].color = '#CCCCCC';
                    }
                    else {
                        // show the data series
                        columns[col] = col;
                        series[col - 1].color = null;
                    }
                    var view = new google.visualization.DataView(data);
                    view.setColumns(columns);
                    chart.draw(view, options);
                }
            }
        });
    };

    $(window).resize(function(){
        drawChart();
    });
</script>

{% include "goals/logGoal.html" %}

<!-- Reveal Modals begin -->
<div id="reveal_edit" class="reveal-modal medium" style="display: none" data-reveal>
  <h2> Please Re-authenticate </h2>
  <br>
  <label for='password'>Confirm Password
    <input id='password' type="password" required/>
    <small id="password-error" style="display:None" class="error">A password is required</small>
  </label>
  <ul class="button-group right">
    <li><a id = "Confirm_button" class="button large pull-2 radius alert"> Confirm </a></li>
    <li><a id = "Back_button" class="button large  radius"> Back </a></li>
  </ul>
  <a class="close-reveal-modal">&#215;</a>
</div>


<!-- Reveal Modals begin -->
<div id="reveal_email" class="reveal-modal medium" style="display: none" data-reveal>
  <h2> Invite Friends </h2>
  <br>
  <div class="row" id="wrapper">
    <div class="large-12 columns" id="wrapper2">
      <div class="row collapse">
        <div class="small-12 columns">
          <input id='to' type="text" placeholder="Friend's Email">
          <p style="font-size:x-small">Insert commas between multiple email addresses <a href="#" onClick="MyWindow=window.open('/email/preview','MyWindow','width=600,height=900'); return false;" data-popup="height=550,width=750">Preview Email</a></p>
        </div>
      </div>
    </div>
  <ul class="button-group right">
    <li><a id = "send_button" class="button large pull-2 radius alert"> Send </a></li>
    <li><a id = "cancle_button" class="button large  radius"> Cancle </a></li>
  </ul>
  <a class="close-reveal-modal">&#215;</a>
    </div>
</div>
    
{% endblock %}

